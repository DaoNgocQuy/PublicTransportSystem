<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Chi tiết tuyến</title>
    <th:block th:replace="base :: bootstrap"></th:block>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        .route-header {
            background-color: #0d6efd;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .badge-route {
            background-color: white;
            color: #333;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: 500;
        }
        .action-btn {
            margin-right: 5px;
        }
        #map {
            height: 400px !important; /* Thêm !important để đảm bảo kích thước */
            width: 100%;
        }
        .direction-tabs {
            margin-bottom: 20px;
        }
        .direction-tabs .nav-link {
            font-weight: bold;
        }
        .direction-tabs .nav-link.active {
            background-color: #0d6efd;
            color: white;
        }
        .stop-list .list-group-item {
            border-left: 3px solid #28a745;
            margin-bottom: 5px;
            transition: all 0.2s ease;
        }

        .stop-list .list-group-item:hover {
            background-color: rgba(40, 167, 69, 0.05);
        }

        .stop-list .list-group-item:last-child {
            border-left: 3px solid #dc3545;
        }

        /* Add scrollable container style */
        .stop-list-scroll {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
        }

        /* Custom scrollbar for webkit browsers */
        .stop-list-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .stop-list-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .stop-list-scroll::-webkit-scrollbar-thumb {
            background: #28a745;
            border-radius: 10px;
        }

        .stop-list-scroll::-webkit-scrollbar-thumb:hover {
            background: #218838;
        }


    </style>
</head>
<body>
    <div class="container my-4">
        <div th:replace="base :: header"></div>

        <!-- Nút quay lại -->
        <div class="mb-3">
            <button class="btn btn-secondary" onclick="window.history.back()">
                <i class="bi bi-arrow-left"></i> Quay lại
            </button>
        </div>

        <!-- Header tuyến đường -->
        <div class="route-header">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="mb-0" th:text="${route.name}">Tuyến 1</h2>
                <span class="badge-route">Tuyến buýt</span>
            </div>
        </div>

        <div class="row">
            <!-- Thông tin cơ bản -->
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h3>Thông tin tuyến</h3>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <tr>
                                <th>ID tuyến:</th>
                                <td th:text="${route.id}">1</td>
                            </tr>
                            <tr>
                                <th>Tên tuyến:</th>
                                <td th:text="${route.name}">Tuyến 1</td>
                            </tr>
                            <tr>
                                <th>Điểm bắt đầu:</th>
                                <td th:text="${route.startLocation}">Điểm đầu</td>
                            </tr>
                            <tr>
                                <th>Điểm kết thúc:</th>
                                <td th:text="${route.endLocation}">Điểm cuối</td>
                            </tr>
                            <tr th:if="${route.operationStartTime != null && route.operationEndTime != null}">
                                <th>Giờ hoạt động:</th>
                                <td>
                                    <span th:text="${#dates.format(route.operationStartTime, 'HH:mm')}">06:00</span> - 
                                    <span th:text="${#dates.format(route.operationEndTime, 'HH:mm')}">22:00</span>
                                </td>
                            </tr>
                            <tr th:if="${route.frequencyMinutes != null}">
                                <th>Tần suất:</th>
                                <td>
                                    <span th:text="${route.frequencyMinutes}">10</span> phút/chuyến
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Thao tác -->
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h3>Thao tác</h3>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a th:href="@{/routes/edit/{id}(id=${route.id}, direction=${currentDirection})}" class="btn btn-warning">
                                <i class="bi bi-pencil"></i> Sửa tuyến
                            </a>
                            <a th:href="@{/stops/create(routeId=${route.id}, direction=${currentDirection})}" class="btn btn-success">
                                <i class="bi bi-plus-circle"></i> Thêm trạm dừng
                            </a>
                            <a th:href="@{/schedules/add(routeId=${route.id})}" class="btn btn-info">
                                <i class="bi bi-calendar-plus"></i> Thêm lịch trình
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bản đồ -->
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h3>Bản đồ tuyến đường</h3>
                    </div>
                    <div class="card-body">
                        <div id="map"></div>
                    </div>
                </div>
            </div>

            <!-- Tabs cho chiều đi/về -->
            <div class="col-md-12">
                <div class="direction-tabs">
                    <ul class="nav nav-tabs justify-content-end" id="directionTabs" role="tablist">
                        <li class="nav-item" role="presentation" th:if="${hasInbound}">
                            <a class="nav-link" th:classappend="${currentDirection == 1 ? 'active' : ''}" 
                               th:href="@{/routes/view/{id}(id=${route.id}, direction=1)}" role="tab">
                                <i class="bi bi-arrow-right"></i> Chiều đi
                            </a>
                        </li>
                        <li class="nav-item" role="presentation" th:if="${hasOutbound}">
                            <a class="nav-link" th:classappend="${currentDirection == 2 ? 'active' : ''}" 
                               th:href="@{/routes/view/{id}(id=${route.id}, direction=2)}" role="tab">
                                <i class="bi bi-arrow-left"></i> Chiều về
                            </a>
                        </li>
                        <li class="nav-item" role="presentation" th:if="${!hasInbound && !hasOutbound}">
                            <span class="nav-link active">Tuyến đường</span>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Danh sách trạm dừng và lịch trình cạnh nhau -->
            <div class="col-md-7">
                <div class="card mb-4">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <span th:if="${currentDirection == 1}">Trạm dừng (Chiều đi)</span>
                            <span th:if="${currentDirection == 2}">Trạm dừng (Chiều về)</span>
                            <span th:if="${currentDirection == null}">Trạm dừng</span>
                        </h5>
                        <a th:href="@{/stops/create(routeId=${route.id}, direction=${currentDirection})}" class="btn btn-light btn-sm">
                            <i class="bi bi-plus-circle"></i> Thêm trạm
                        </a>
                    </div>
                    <div class="card-body p-2">
                        <div th:if="${stops == null || stops.isEmpty()}" class="alert alert-info py-2">
                            Tuyến này chưa có trạm dừng nào cho chiều này.
                        </div>

                        <div th:unless="${stops == null || stops.isEmpty()}" 
                             th:classappend="${stops.size() > 8 ? 'stop-list-scroll' : ''}" 
                             class="list-group stop-list">
                            <!-- Điểm xuất phát -->
                            <div class="list-group-item list-group-item-action d-flex align-items-center py-2" 
                                 th:each="stop, iterStat : ${stops}">
                                <div class="me-2">
                                    <div th:if="${iterStat.first}" class="rounded-circle bg-success text-white d-flex justify-content-center align-items-center" 
                                         style="width: 30px; height: 30px; font-weight: bold;">
                                        A
                                    </div>
                                    <div th:unless="${iterStat.first || iterStat.last}" class="rounded-circle bg-primary text-white d-flex justify-content-center align-items-center" 
                                         style="width: 30px; height: 30px; font-weight: bold;" th:text="${iterStat.index}">
                                        1
                                    </div>
                                    <div th:if="${iterStat.last && !iterStat.first}" class="rounded-circle bg-danger text-white d-flex justify-content-center align-items-center" 
                                         style="width: 30px; height: 30px; font-weight: bold;">
                                        B
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0" th:text="${stop.stopName}">Tên trạm</h6>
                                        <div>
                                            <span th:if="${stop.isAccessible}" class="badge bg-success me-1">✓</span>
                                            <span th:unless="${stop.isAccessible}" class="badge bg-secondary me-1">✗</span>
                                            <a th:href="@{/stops/view/{id}(id=${stop.id})}" class="btn btn-sm btn-info action-btn p-0 px-1">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <a th:href="@{/stops/edit/{id}(id=${stop.id})}" class="btn btn-sm btn-warning action-btn p-0 px-1">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <a th:href="@{/routes/{routeId}/stops/{stopId}/remove(routeId=${route.id}, stopId=${stop.id}, direction=${currentDirection})}"
                                               onclick="return confirm('Bạn có chắc chắn muốn xóa trạm dừng này khỏi tuyến?');"
                                               class="btn btn-sm btn-danger action-btn p-0 px-1">
                                                <i class="bi bi-x"></i>
                                            </a>
                                        </div>
                                    </div>
                                    <small class="text-muted" th:text="${stop.address ?: 'Không có địa chỉ'}">Địa chỉ</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lịch trình -->
            <div class="col-md-5">
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Lịch trình</h5>
                        <a th:href="@{/schedules/add(routeId=${route.id})}" class="btn btn-light btn-sm">
                            <i class="bi bi-plus-circle"></i> Thêm lịch trình
                        </a>
                    </div>
                    <div class="card-body p-2">
                        <div th:if="${schedules == null || schedules.isEmpty()}" class="alert alert-info py-2">
                            Tuyến này chưa có lịch trình nào.
                        </div>

                        <div th:unless="${schedules == null || schedules.isEmpty()}" class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Giờ bắt đầu</th>
                                        <th>Giờ kết thúc</th>
                                        <th>Hành động</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="schedule : ${schedules}">
                                        <td th:text="${schedule.departureTime != null ? #dates.format(schedule.departureTime, 'HH:mm') : '-'}">06:00</td>
                                        <td th:text="${schedule.arrivalTime != null ? #dates.format(schedule.arrivalTime, 'HH:mm') : '-'}">22:00</td>
                                        <td>
                                            <a th:href="@{/schedules/edit/{id}(id=${schedule.id})}" class="btn btn-sm btn-warning action-btn p-0 px-1">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <a th:href="@{/schedules/delete/{id}(id=${schedule.id})}"
                                               onclick="return confirm('Bạn có chắc chắn muốn xóa lịch trình này?');"
                                               class="btn btn-sm btn-danger action-btn p-0 px-1">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="base :: footer"></div>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-polylinedecorator/1.6.0/leaflet.polylineDecorator.min.js"></script>

<script th:inline="javascript">
                                                   /*<![CDATA[*/
                                                   console.log("view.js loaded!");

                                                   // Giải mã polyline (được sử dụng bởi OSRM)
                                                   L.Polyline.fromEncoded = function (encoded, options) {
                                                       var polyline = L.polyline([], options);
                                                       polyline.setLatLngs(L.PolylineUtil.decode(encoded));
                                                       return polyline;
                                                   };

                                                   L.PolylineUtil = {
                                                       // Giải mã chuỗi polyline thành mảng tọa độ [lat, lng]
                                                       decode: function (str, precision) {
                                                           var index = 0,
                                                                   lat = 0,
                                                                   lng = 0,
                                                                   coordinates = [],
                                                                   shift = 0,
                                                                   result = 0,
                                                                   byte = null,
                                                                   latitude_change,
                                                                   longitude_change,
                                                                   factor = Math.pow(10, precision || 5);

                                                           // Đọc lat và lng cho đến khi hết chuỗi str
                                                           while (index < str.length) {
                                                               // Reset shift, result, và byte
                                                               byte = null;
                                                               shift = 0;
                                                               result = 0;

                                                               do {
                                                                   byte = str.charCodeAt(index++) - 63;
                                                                   result |= (byte & 0x1f) << shift;
                                                                   shift += 5;
                                                               } while (byte >= 0x20);

                                                               latitude_change = ((result & 1) ? ~(result >> 1) : (result >> 1));

                                                               shift = result = 0;

                                                               do {
                                                                   byte = str.charCodeAt(index++) - 63;
                                                                   result |= (byte & 0x1f) << shift;
                                                                   shift += 5;
                                                               } while (byte >= 0x20);

                                                               longitude_change = ((result & 1) ? ~(result >> 1) : (result >> 1));

                                                               lat += latitude_change;
                                                               lng += longitude_change;

                                                               coordinates.push([lat / factor, lng / factor]);
                                                           }

                                                           return coordinates;
                                                       }
                                                   };

                                                   // Khởi tạo bản đồ sau khi trang đã tải xong
                                                   function initRouteMap(coordinates, currentDirection) {
                                                       var map = L.map('map').setView([10.77, 106.69], 13);

                                                       L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                                           attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
                                                       }).addTo(map);

                                                       // Kiểm tra nếu có tọa độ
                                                       if (coordinates && coordinates.length > 0) {
                                                           var markers = [];
                                                           var validCoordinates = coordinates.filter(function (coord) {
                                                               return coord && Array.isArray(coord) && coord.length === 2 &&
                                                                       !isNaN(coord[0]) && !isNaN(coord[1]);
                                                           });

                                                           if (validCoordinates.length > 0) {
                                                               // Tạo polyline đơn giản kết nối các điểm ban đầu
                                                               var simplePolyline = L.polyline(validCoordinates, {
                                                                   color: currentDirection === 1 ? 'blue' : 'green',
                                                                   weight: 2,
                                                                   dashArray: '5,10',
                                                                   opacity: 0.6
                                                               }).addTo(map);

                                                               // Nếu có ít nhất 2 điểm, sử dụng OSRM để vẽ đường đi theo đường phố
                                                               if (validCoordinates.length >= 2) {
                                                                   // Tạo URL cho API OSRM
                                                                   var waypointsStr = validCoordinates.map(function (coord) {
                                                                       return coord[1] + ',' + coord[0]; // OSRM yêu cầu định dạng [lon, lat]
                                                                   }).join(';');

                                                                   var url = 'https://router.project-osrm.org/route/v1/driving/' + waypointsStr +
                                                                           '?overview=full&geometries=polyline&steps=true&continue_straight=true';

                                                                   // Gọi API OSRM
                                                                   $.ajax({
                                                                       url: url,
                                                                       method: 'GET',
                                                                       dataType: 'json',
                                                                       success: function (data) {
                                                                           if (data.code === 'Ok') {
                                                                               // Giải mã tọa độ polyline từ phản hồi
                                                                               var encoded = data.routes[0].geometry;
                                                                               var routeCoords = L.PolylineUtil.decode(encoded);

                                                                               // Vẽ tuyến đường chính
                                                                               var routePolyline = L.polyline(routeCoords, {
                                                                                   color: currentDirection === 1 ? 'blue' : 'green',
                                                                                   weight: 5,
                                                                                   opacity: 0.8
                                                                               }).addTo(map);

                                                                               // Tìm điểm gần nhất trên đường polyline cho mỗi trạm dừng
                                                                               for (var i = 0; i < validCoordinates.length; i++) {
                                                                                   var stop = validCoordinates[i];
                                                                                   var closestPoint = findClosestPointOnPolyline(stop, routeCoords);

                                                                                   // Sử dụng điểm gần nhất trên polyline làm vị trí trạm
                                                                                   var adjustedPosition = closestPoint;

                                                                                   // Tạo marker với icon phù hợp
                                                                                   var markerIcon = L.divIcon({
                                                                                       html: getStopMarkerHtml(i, validCoordinates.length),
                                                                                       className: 'marker-station',
                                                                                       iconSize: [24, 24],
                                                                                       iconAnchor: [12, 12]
                                                                                   });

                                                                                   var marker = L.marker(adjustedPosition, {icon: markerIcon}).addTo(map);

                                                                                   // Thêm thông tin chiều vào popup và chỉ số trạm theo thứ tự
                                                                                   var popupContent = getStopPopupContent(i, validCoordinates.length, currentDirection);
                                                                                   marker.bindPopup(popupContent);
                                                                                   markers.push(marker);

                                                                                   // Vẽ đường nối từ vị trí thực tế đến điểm trên đường nếu khoảng cách > 10m
                                                                                   var distance = calculateDistance(stop, adjustedPosition);
                                                                                   if (distance > 0.01) { // 0.01 km = 10m
                                                                                       L.polyline([stop, adjustedPosition], {
                                                                                           color: 'gray',
                                                                                           weight: 1,
                                                                                           dashArray: '3,6',
                                                                                           opacity: 0.5
                                                                                       }).addTo(map);
                                                                                   }
                                                                               }

                                                                               // Xóa polyline đơn giản
                                                                               map.removeLayer(simplePolyline);

                                                                               // Fit bản đồ vào tất cả điểm
                                                                               var group = new L.featureGroup(markers.concat([routePolyline]));
                                                                               map.fitBounds(group.getBounds(), {padding: [30, 30]});
                                                                           } else {
                                                                               console.error('Lỗi từ OSRM API:', data.code);
                                                                               addDefaultMarkers(map, validCoordinates, markers, currentDirection);
                                                                           }
                                                                       },
                                                                       error: function (xhr, status, error) {
                                                                           console.error('Lỗi khi gọi OSRM API:', error);
                                                                           addDefaultMarkers(map, validCoordinates, markers, currentDirection);
                                                                       }
                                                                   });
                                                               } else {
                                                                   addDefaultMarkers(map, validCoordinates, markers, currentDirection);
                                                               }
                                                           } else {
                                                               showNoCoordinatesMessage();
                                                           }
                                                       } else {
                                                           showNoCoordinatesMessage();
                                                       }

                                                       return map;
                                                   }

                                                   // Hàm tạo HTML cho marker
                                                   function getStopMarkerHtml(index, total) {
                                                       if (index === 0) {
                                                           // Điểm đầu (A)
                                                           return '<div style="background-color: #28a745; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; justify-content: center; align-items: center; font-weight: bold;">A</div>';
                                                       } else if (index === total - 1) {
                                                           // Điểm cuối (B)
                                                           return '<div style="background-color: #dc3545; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; justify-content: center; align-items: center; font-weight: bold;">B</div>';
                                                       } else {
                                                           // Điểm trung gian (số)
                                                           return '<div style="background-color: #0d6efd; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; justify-content: center; align-items: center; font-weight: bold;">' + index + '</div>';
                                                       }
                                                   }

                                                   // Hàm tạo nội dung popup
                                                   function getStopPopupContent(index, total, direction) {
                                                       var stopType = "";

                                                       if (index === 0) {
                                                           stopType = "<strong>Điểm xuất phát (A)</strong>";
                                                       } else if (index === total - 1) {
                                                           stopType = "<strong>Điểm kết thúc (B)</strong>";
                                                       } else {
                                                           stopType = "<strong>Trạm số " + index + "</strong>";
                                                       }

                                                       var directionText = "";
                                                       if (direction === 1) {
                                                           directionText = " (Chiều đi)";
                                                       } else if (direction === 2) {
                                                           directionText = " (Chiều về)";
                                                       }

                                                       return stopType + directionText;
                                                   }

                                                   // Hàm tìm điểm gần nhất trên polyline
                                                   function findClosestPointOnPolyline(point, polyline) {
                                                       var closestPoint = polyline[0];
                                                       var minDistance = calculateDistance(point, polyline[0]);

                                                       for (var i = 1; i < polyline.length; i++) {
                                                           var distance = calculateDistance(point, polyline[i]);
                                                           if (distance < minDistance) {
                                                               minDistance = distance;
                                                               closestPoint = polyline[i];
                                                           }
                                                       }
                                                       return closestPoint;
                                                   }

                                                   // Hàm tính khoảng cách giữa hai điểm (theo công thức Haversine)
                                                   function calculateDistance(point1, point2) {
                                                       var lat1 = point1[0], lon1 = point1[1];
                                                       var lat2 = point2[0], lon2 = point2[1];

                                                       var R = 6371; // Bán kính Trái Đất (km)
                                                       var dLat = deg2rad(lat2 - lat1);
                                                       var dLon = deg2rad(lon2 - lon1);
                                                       var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                                                               Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                                                               Math.sin(dLon / 2) * Math.sin(dLon / 2);
                                                       var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                                                       var d = R * c; // Khoảng cách (km)
                                                       return d;
                                                   }

                                                   function deg2rad(deg) {
                                                       return deg * (Math.PI / 180);
                                                   }

                                                   // Thêm các marker mặc định khi không dùng OSRM
                                                   function addDefaultMarkers(map, validCoordinates, markers, currentDirection) {
                                                       validCoordinates.forEach(function (coord, index) {
                                                           var markerIcon = L.divIcon({
                                                               html: getStopMarkerHtml(index, validCoordinates.length),
                                                               className: 'marker-station',
                                                               iconSize: [24, 24],
                                                               iconAnchor: [12, 12]
                                                           });

                                                           var marker = L.marker([coord[0], coord[1]], {icon: markerIcon}).addTo(map);
                                                           var popupContent = getStopPopupContent(index, validCoordinates.length, currentDirection);
                                                           marker.bindPopup(popupContent);
                                                           markers.push(marker);
                                                       });

                                                       fitMapToMarkers(map, markers);
                                                   }

                                                   function fitMapToMarkers(map, markers) {
                                                       if (markers.length > 0) {
                                                           var group = new L.featureGroup(markers);
                                                           map.fitBounds(group.getBounds(), {padding: [30, 30]});
                                                       }
                                                   }

                                                   function showNoCoordinatesMessage() {
                                                       document.getElementById('map').innerHTML =
                                                               '<div class="d-flex align-items-center justify-content-center h-100 bg-light">' +
                                                               '<p class="text-muted">Không có tọa độ nào cho tuyến đường này</p></div>';
                                                   }

                                                   // Sử dụng hàm từ file JS
                                                   $(document).ready(function () {
                                                       var coordinates = /*[[${coordinates}]]*/ [];
                                                       var currentDirection = /*[[${currentDirection}]]*/ 1;

                                                       console.log("Coordinates:", coordinates);
                                                       console.log("Direction:", currentDirection);

                                                       initRouteMap(coordinates, currentDirection);
                                                   });
                                                   /*]]>*/
</script>
</body>
</html>