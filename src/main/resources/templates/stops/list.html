<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Danh sách trạm dừng</title>
    <th:block th:replace="base :: bootstrap"></th:block>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>

<body>
    <div class="container mt-4">
        <div th:replace="base :: header"></div>
        <h1 class="text-center text-info mt-1">DANH SÁCH TRẠM DỪNG</h1>

        <!-- Hiển thị thông báo thành công nếu có -->
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div th:if="${confirmDeleteId}" class="alert alert-warning alert-dismissible fade show" role="alert">
            <div class="d-flex align-items-center justify-content-between">
                <span th:text="${confirmMessage}"></span>
                <div class="d-flex gap-2">
                    <a th:href="@{/stops/delete/{id}(id=${confirmDeleteId}, confirmed=true)}"
                        class="btn btn-sm btn-danger">Xác nhận xóa</a>
                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="alert"
                        aria-label="Close">Hủy</button>
                </div>
            </div>
        </div>

        <!-- Tiêu đề và nút thêm mới -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex">
                <a th:href="@{/stops/create}" class="btn btn-primary me-2">
                    <i class="bi bi-plus-circle"></i> Thêm trạm dừng mới
                </a>

                <!-- Thêm form tìm kiếm -->
                <form th:action="@{/stops/search}" method="get" class="d-flex">
                    <input type="text" name="keyword" class="form-control me-2" placeholder="Tìm trạm dừng..."
                        th:value="${keyword != null ? keyword : ''}">
                    <button type="submit" class="btn btn-outline-secondary">
                        <i class="bi bi-search"></i>
                    </button>
                </form>
            </div>
            <span class="badge bg-info py-2 px-3">Tổng số: <span th:text="${stops != null ? stops.size() : 0}">0</span>
                trạm</span>
        </div>

        <!-- Bảng danh sách trạm dừng -->
        <div class="card">
            <div class="card-body">
                <div th:if="${stops.isEmpty()}" class="alert alert-info">
                    Chưa có trạm dừng nào trong hệ thống.
                </div>

                <div th:unless="${stops.isEmpty()}" class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Tên trạm</th>
                                <th>Địa chỉ</th>
                                <th>Tọa độ</th>
                                <th>Tiếp cận</th>
                                <th>Tuyến đường</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="stop : ${stops}">
                                <td th:text="${stop.id}"></td>
                                <td>
                                    <a th:href="@{/stops/view/{id}(id=${stop.id})}"
                                        class="text-decoration-none fw-bold">
                                        <span th:text="${stop.stopName}">Trạm Central Park</span>
                                    </a>
                                </td>
                                <td th:text="${stop.address != null ? stop.address : '-'}">123 đường ABC</td>
                                <td>
                                    <small th:if="${stop.latitude != null && stop.longitude != null}"
                                        class="text-muted">
                                        <span th:text="${#numbers.formatDecimal(stop.latitude, 1, 6)}"></span>,
                                        <span th:text="${#numbers.formatDecimal(stop.longitude, 1, 6)}"></span>
                                    </small>
                                    <span th:unless="${stop.latitude != null && stop.longitude != null}">-</span>
                                </td>
                                <td>
                                    <span th:if="${stop.isAccessible == true}" class="badge bg-success"
                                        title="Tiếp cận được">
                                        <i class="bi bi-wheelchair"></i>
                                    </span>
                                    <span th:unless="${stop.isAccessible == true}" class="badge bg-secondary">
                                        <i class="bi bi-wheelchair"></i>
                                    </span>
                                </td>
                                <td>
                                    <div class="text-center">
                                        <span
                                            th:if="${routeCounts != null && routeCounts.containsKey(stop.id) && routeCounts.get(stop.id) > 0}"
                                            class="badge bg-primary rounded-pill"
                                            th:text="${routeCounts.get(stop.id)} + ' tuyến'"></span>
                                        <span
                                            th:unless="${routeCounts != null && routeCounts.containsKey(stop.id) && routeCounts.get(stop.id) > 0}"
                                            class="text-muted">-</span>
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex gap-1">
                                        <a th:href="@{/stops/view/{id}(id=${stop.id})}" class="btn btn-sm btn-info"
                                            title="Xem chi tiết">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a th:href="@{/stops/edit/{id}(id=${stop.id})}" class="btn btn-sm btn-warning"
                                            title="Chỉnh sửa">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <a th:href="@{/stops/delete/{id}(id=${stop.id})}"
                                            th:data-bs-toggle="${routeCounts != null && routeCounts.containsKey(stop.id) && routeCounts.get(stop.id) > 0 ? 'modal' : ''}"
                                            th:data-bs-target="${routeCounts != null && routeCounts.containsKey(stop.id) && routeCounts.get(stop.id) > 0 ? '#deleteModal' + stop.id : ''}"
                                            class="btn btn-sm btn-danger" title="Xóa">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </div>
                                    <div class="modal fade" th:id="${'deleteModal' + stop.id}" tabindex="-1"
                                        aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header bg-danger text-white">
                                                    <h5 class="modal-title">Cảnh báo xóa trạm</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="alert alert-warning">
                                                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                                        Trạm <strong th:text="${stop.stopName}"></strong> hiện đang
                                                        thuộc
                                                        <strong th:text="${routeCounts.get(stop.id)}"></strong> tuyến.
                                                    </div>
                                                    <p>Bạn có các lựa chọn sau:</p>
                                                    <ol>
                                                        <li><strong>Xóa khỏi tất cả tuyến:</strong> Xóa trạm khỏi tất cả
                                                            các tuyến và xóa trạm hoàn toàn.</li>
                                                        <li><strong>Chỉnh sửa trạm:</strong> Chuyển đến trang chỉnh sửa
                                                            trạm để xóa từ từng tuyến.</li>
                                                        <li><strong>Hủy:</strong> Không thực hiện thao tác nào.</li>
                                                    </ol>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary"
                                                        data-bs-dismiss="modal">Hủy</button>
                                                    <a th:href="@{/stops/edit/{id}(id=${stop.id})}"
                                                        class="btn btn-primary">
                                                        Chỉnh sửa trạm
                                                    </a>
                                                    <a th:href="@{/stops/forceDelete/{id}(id=${stop.id})}"
                                                        onclick="return confirm('CẢNH BÁO: Thao tác này sẽ xóa trạm khỏi TẤT CẢ các tuyến. Tiếp tục?');"
                                                        class="btn btn-danger">
                                                        Xóa khỏi tất cả tuyến
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div th:replace="base :: footer"></div>
    </div>
</body>

</html>